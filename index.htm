<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio Brasileiro - Exporta√ß√£o e Gest√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca para capturar o HTML como imagem -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .numero-marrom { color: #8B4513; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #fdf8f5; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 10px; }

        #settings-drawer { transition: transform 0.3s ease-in-out; }
        .drawer-closed { transform: translateX(100%); }
        .drawer-open { transform: translateX(0); }

        /* Estilo para garantir que o conte√∫do exportado mantenha propor√ß√µes */
        #export-container { background-color: #fdf8f5; }
    </style>
</head>
<body class="bg-[#fdf8f5] min-h-screen relative overflow-x-hidden">

    <!-- CABE√áALHO GLOBAL (FORA DA √ÅREA DO CALEND√ÅRIO) -->
    <header class="max-w-[1600px] mx-auto p-4 md:p-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <h1 id="today-date-display" class="text-2xl font-black text-amber-900 tracking-tight"></h1>
        </div>

        <button id="open-settings" class="flex items-center gap-2 bg-white hover:bg-amber-50 text-amber-900 px-5 py-2.5 rounded-xl font-bold transition shadow-sm border border-amber-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            </svg>
            Configura√ß√µes
        </button>
    </header>

    <!-- CONTAINER TEMPOR√ÅRIO PARA EXPORTA√á√ÉO PDF -->
    <div id="pdf-render-temp" style="position: absolute; left: -10000px; top: 0; width: 1200px; background-color: white;"></div>

    <main id="export-container" class="max-w-[1600px] mx-auto px-4 md:px-6 pb-10">

        <!-- √ÅREA DO CALEND√ÅRIO -->
        <div id="calendar-wrapper" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-amber-100 flex flex-col h-full relative">

            <!-- Cabe√ßalho Interno do Calend√°rio -->
            <div class="bg-amber-50 px-4 md:px-8 py-4 md:py-6 flex items-center justify-between border-b border-amber-200">
                <button id="prev-month" class="p-3 rounded-full hover:bg-amber-200 text-amber-900 transition flex items-center justify-center bg-white shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>

                <h2 id="month-year-display" class="text-xl sm:text-2xl md:text-4xl font-black text-amber-900 uppercase tracking-tighter text-center min-w-0 flex-1">
                    M√™s Ano
                </h2>

                <div class="flex items-center gap-2">
                    <button id="next-month" class="p-3 rounded-full hover:bg-amber-200 text-amber-900 transition flex items-center justify-center bg-white shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                    <button id="toggle-layout" class="p-3 rounded-full hover:bg-amber-200 text-amber-900 transition flex items-center justify-center bg-white shadow-sm" title="Alternar Layout">
                        <svg id="layout-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Grid do Calend√°rio -->
            <div class="p-6 overflow-x-auto no-scrollbar flex-1 bg-white">
                <div id="calendar-container-inner" class="min-w-[900px]">
                    <div id="calendar-days-header" class="grid grid-cols-7 gap-px mb-4 border-b-2 border-amber-100">
                        <div class="text-center font-black text-amber-800 py-3 text-sm">DOMINGO</div>
                        <div class="text-center font-black text-amber-800 py-3 text-sm">SEGUNDA</div>
                        <div class="text-center font-black text-amber-800 py-3 text-sm">TER√áA</div>
                        <div class="text-center font-black text-amber-800 py-3 text-sm">QUARTA</div>
                        <div class="text-center font-black text-amber-800 py-3 text-sm">QUINTA</div>
                        <div class="text-center font-black text-amber-800 py-3 text-sm">SEXTA</div>
                        <div class="text-center font-black text-amber-800 py-3 text-sm">S√ÅBADO</div>
                    </div>

                    <div id="calendar-grid" class="grid grid-cols-7 gap-3">
                        <!-- Dias injetados -->
                    </div>
                </div>
            </div>

            <!-- Legenda -->
            <div class="bg-amber-50 border-t border-amber-200 p-4 text-xs text-amber-900 flex flex-wrap gap-x-6 gap-y-2 justify-center items-center font-bold uppercase tracking-wider">
                <div class="flex gap-2">üåë üåì üåï üåó Fases da Lua</div>
                <div class="w-px h-4 bg-amber-300"></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-400"></span> Feriados</div>
                <div class="w-px h-4 bg-amber-300"></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-400"></span> Astros</div>
                <div class="w-px h-4 bg-amber-300"></div>
                <div>üçÇ Outono ‚Ä¢ ‚ùÑÔ∏è Inverno ‚Ä¢ üå∏ Prim. ‚Ä¢ ‚òÄÔ∏è Ver√£o</div>
            </div>
        </div>
    </main>

    <!-- PAINEL LATERAL (DRAWER) -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity"></div>

    <div id="settings-drawer" class="fixed right-0 top-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 drawer-closed border-l border-amber-100 flex flex-col">
        <div class="p-6 bg-amber-50 border-b border-amber-200 flex justify-between items-center">
            <h2 class="text-xl font-black text-amber-900 flex items-center gap-2">
                CONFIGURA√á√ïES
            </h2>
            <button id="close-settings" class="p-2 hover:bg-amber-200 rounded-full text-amber-900 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
            <!-- A√á√ÉO DE EXPORTA√á√ÉO -->
            <section>
                <h3 class="text-xs font-black text-amber-800 uppercase tracking-widest mb-4">Exportar</h3>
                <button id="download-image" class="w-full group flex items-center justify-center gap-3 bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-2xl transition-all shadow-lg active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    BAIXAR COMO IMAGEM (HD)
                </button>
                <p class="text-[10px] text-gray-400 mt-2 text-center uppercase font-bold">Gera um arquivo PNG de alta resolu√ß√£o</p>
            </section>

            <!-- EXPORTAR PDF -->
            <section>
                <h3 class="text-xs font-black text-amber-800 uppercase tracking-widest mb-4">Exportar PDF (A4)</h3>
                <div class="space-y-4 bg-amber-50/50 p-5 rounded-2xl border border-amber-100 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase">M√™s In√≠cio</label>
                            <select id="pdf-start-month" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                                <!-- Options will be filled by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase">Ano In√≠cio</label>
                            <input type="number" id="pdf-start-year" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase">M√™s Fim</label>
                            <select id="pdf-end-month" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                                <!-- Options will be filled by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase">Ano Fim</label>
                            <input type="number" id="pdf-end-year" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                        </div>
                    </div>
                </div>
                <button id="download-pdf" class="w-full group flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl transition-all shadow-lg active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    BAIXAR COMO PDF (A4)
                </button>
                <p class="text-[10px] text-gray-400 mt-2 text-center uppercase font-bold">Gera um arquivo PDF com um m√™s por p√°gina</p>
            </section>

            <!-- BACKUP -->
            <section>
                <h3 class="text-xs font-black text-amber-800 uppercase tracking-widest mb-4">Backup de Dados</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button id="export-data" class="flex flex-col items-center justify-center gap-2 bg-amber-100 hover:bg-amber-200 text-amber-900 font-bold py-4 rounded-2xl transition-all shadow-sm active:scale-95 border border-amber-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span class="text-[10px] uppercase">Exportar Dados (TXT)</span>
                    </button>
                    <button id="import-data-trigger" class="flex flex-col items-center justify-center gap-2 bg-amber-100 hover:bg-amber-200 text-amber-900 font-bold py-4 rounded-2xl transition-all shadow-sm active:scale-95 border border-amber-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span class="text-[10px] uppercase">Importar Dados (TXT)</span>
                    </button>
                    <input type="file" id="import-data-file" class="hidden" accept=".txt,.json">
                </div>
            </section>

            <!-- EVENTO -->
            <section>
                <h3 class="text-xs font-black text-amber-800 uppercase tracking-widest mb-4">Evento</h3>
                <div class="space-y-4 bg-amber-50/50 p-5 rounded-2xl border border-amber-100">
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase">Nome</label>
                        <input type="text" id="bday-name" placeholder="" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-500 mb-1 uppercase">Tipo de Evento</label>
                        <select id="event-type" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                            <option value="Evento √önico">Evento √önico</option>
                            <option value="Anivers√°rio" selected>Anivers√°rio</option>
                        </select>
                    </div>
                    <div>
                        <label id="date-label" class="block text-[10px] font-black text-gray-500 mb-1 uppercase">Data inicial</label>
                        <input type="date" id="bday-date" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-400 focus:outline-none transition bg-white font-bold">
                    </div>
                    <button id="add-bday" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-black py-3 rounded-xl transition-all shadow-md">
                        SALVAR EVENTO
                    </button>
                </div>
            </section>

            <!-- LISTA -->
            <section>
                <h3 class="text-xs font-black text-amber-800 uppercase tracking-widest mb-4">Eventos Cadastrados</h3>
                <div id="bday-list" class="space-y-3">
                    <p class="text-gray-400 text-sm italic text-center py-4">Nenhum registro.</p>
                </div>
            </section>
        </div>
    </div>

    <!-- MODAL DE BACKUP -->
    <div id="backup-modal-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
        <div id="backup-modal" class="bg-white rounded-3xl max-w-sm w-full p-8 shadow-2xl space-y-6 scale-95 transition-transform">
            <h3 class="text-2xl font-black text-amber-900 text-center">Fazer Backup?</h3>
            <p class="text-gray-600 text-center font-medium">Recomendamos salvar seus dados para n√£o perd√™-los.</p>
            <div class="space-y-3">
                <button id="backup-download" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-black py-4 rounded-2xl transition shadow-md active:scale-95">FAZER BACKUP</button>
                <button id="backup-whatsapp" class="w-full bg-green-500 hover:bg-green-600 text-white font-black py-4 rounded-2xl transition shadow-md active:scale-95">ENVIAR POR WHATSAPP</button>
                <button id="backup-later" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-500 font-black py-4 rounded-2xl transition active:scale-95">DEIXAR PARA DEPOIS</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO DE EXCLUS√ÉO -->
    <div id="confirm-modal-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
        <div id="confirm-modal" class="bg-white rounded-3xl max-w-sm w-full p-8 shadow-2xl space-y-6 scale-95 transition-transform">
            <h3 class="text-2xl font-black text-amber-900 text-center uppercase">Excluir Evento?</h3>
            <p class="text-gray-600 text-center font-medium">Tem certeza que deseja remover este evento? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="grid grid-cols-2 gap-3">
                <button id="confirm-cancel" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-500 font-black py-4 rounded-2xl transition active:scale-95 uppercase text-xs">Cancelar</button>
                <button id="confirm-delete" class="w-full bg-red-500 hover:bg-red-600 text-white font-black py-4 rounded-2xl transition shadow-md active:scale-95 uppercase text-xs">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        const today = new Date();
        const formattedToday = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
        document.getElementById('today-date-display').textContent = formattedToday;

        const sanitize = (str) => str.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));

        // --- FUN√á√ïES DE MODAL DE BACKUP ---
        function showBackupModal() {
            const overlay = document.getElementById('backup-modal-overlay');
            const modal = document.getElementById('backup-modal');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('opacity-100');
                modal.classList.remove('scale-95');
                modal.classList.add('scale-100');
            }, 10);
        }

        function closeBackupModal() {
            const overlay = document.getElementById('backup-modal-overlay');
            const modal = document.getElementById('backup-modal');
            overlay.classList.remove('opacity-100');
            modal.classList.remove('scale-100');
            modal.classList.add('scale-95');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        // --- FUN√á√ïES DE CONFIRMA√á√ÉO DE EXCLUS√ÉO ---
        let bdayIdToDelete = null;

        function showConfirmModal(id) {
            bdayIdToDelete = id;
            const overlay = document.getElementById('confirm-modal-overlay');
            const modal = document.getElementById('confirm-modal');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('opacity-100');
                modal.classList.remove('scale-95');
                modal.classList.add('scale-100');
            }, 10);
        }

        function closeConfirmModal() {
            const overlay = document.getElementById('confirm-modal-overlay');
            const modal = document.getElementById('confirm-modal');
            overlay.classList.remove('opacity-100');
            modal.classList.remove('scale-100');
            modal.classList.add('scale-95');
            setTimeout(() => {
                overlay.classList.add('hidden');
                bdayIdToDelete = null;
            }, 300);
        }

        document.getElementById('confirm-delete').addEventListener('click', () => {
            if (bdayIdToDelete) {
                removeBday(bdayIdToDelete);
                closeConfirmModal();
            }
        });

        document.getElementById('confirm-cancel').addEventListener('click', () => {
            closeConfirmModal();
        });

        document.getElementById('confirm-modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'confirm-modal-overlay') closeConfirmModal();
        });

        function getBackupText() {
            const sorted = [...birthdays].sort((a, b) => (a.month * 100 + a.day) - (b.month * 100 + b.day));
            let content = "BACKUP DO CALEND√ÅRIO:\n\n";
            sorted.forEach(b => {
                const day = b.day.toString().padStart(2, '0');
                const month = (b.month + 1).toString().padStart(2, '0');
                const year = b.birthYear;
                content += `${day}/${month}/${year} - ${b.name} (${b.type || 'Anivers√°rio'})\n`;
            });
            return content;
        }

        function exportToWhatsApp() {
            const text = getBackupText();
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        document.getElementById('backup-download').addEventListener('click', () => {
            document.getElementById('export-data').click();
            closeBackupModal();
        });

        document.getElementById('backup-whatsapp').addEventListener('click', () => {
            exportToWhatsApp();
            closeBackupModal();
        });

        document.getElementById('backup-later').addEventListener('click', () => {
            closeBackupModal();
        });

        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        let birthdays = JSON.parse(localStorage.getItem('user_birthdays_v3') || '[]');
        let isListView = window.innerWidth < 768;
        let lastWidth = window.innerWidth;

        const monthYearDisplay = document.getElementById('month-year-display');
        const calendarGrid = document.getElementById('calendar-grid');
        const bdayListContainer = document.getElementById('bday-list');
        const settingsDrawer = document.getElementById('settings-drawer');

        // --- L√ìGICA DE TIPO DE EVENTO ---
        document.getElementById('event-type').addEventListener('change', (e) => {
            const label = document.getElementById('date-label');
            if (e.target.value === 'Anivers√°rio') {
                label.textContent = 'Data inicial';
            } else {
                label.textContent = 'Data';
            }
        });

        // --- INICIALIZAR INPUTS PDF ---
        const pdfStartMonth = document.getElementById('pdf-start-month');
        const pdfEndMonth = document.getElementById('pdf-end-month');
        const pdfStartYear = document.getElementById('pdf-start-year');
        const pdfEndYear = document.getElementById('pdf-end-year');

        monthNames.forEach((name, i) => {
            pdfStartMonth.add(new Option(name.toUpperCase(), i));
            pdfEndMonth.add(new Option(name.toUpperCase(), i));
        });

        pdfStartMonth.value = currentMonth;
        pdfEndMonth.value = currentMonth;
        pdfStartYear.value = currentYear;
        pdfEndYear.value = currentYear;
        const drawerOverlay = document.getElementById('drawer-overlay');

        // --- EXPORTA√á√ÉO DE IMAGEM ---
        document.getElementById('download-image').addEventListener('click', async () => {
            const btn = document.getElementById('download-image');
            const originalText = btn.innerText;
            btn.innerText = "GERANDO ARQUIVO...";
            btn.disabled = true;

            const target = document.getElementById('calendar-wrapper');

            try {
                const canvas = await html2canvas(target, {
                    scale: 3, // Aumenta a resolu√ß√£o em 3x (Alta Qualidade)
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    logging: false
                });

                const link = document.createElement('a');
                const fileName = `Calendario_${monthNames[currentMonth]}_${currentYear}.png`;
                link.download = fileName;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            } catch (err) {
                console.error("Erro ao exportar:", err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // --- CONTROLES ---
        function toggleDrawer(open) {
            if (open) {
                settingsDrawer.classList.remove('drawer-closed');
                settingsDrawer.classList.add('drawer-open');
                drawerOverlay.classList.remove('hidden');
                setTimeout(() => drawerOverlay.classList.add('opacity-100'), 10);
            } else {
                settingsDrawer.classList.remove('drawer-open');
                settingsDrawer.classList.add('drawer-closed');
                drawerOverlay.classList.remove('opacity-100');
                setTimeout(() => drawerOverlay.classList.add('hidden'), 300);
            }
        }

        document.getElementById('open-settings').addEventListener('click', () => toggleDrawer(true));
        document.getElementById('close-settings').addEventListener('click', () => toggleDrawer(false));
        drawerOverlay.addEventListener('click', () => toggleDrawer(false));

        // --- L√ìGICA DE DATAS ---
        function getEasterDate(year) {
            const a = year % 19, b = Math.floor(year / 100), c = year % 100;
            const d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1, day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month, day);
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDateKey(day, month) {
            return `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}`;
        }

        function getHolidays(year) {
            const easter = getEasterDate(year);
            const h = {
                "01/01": { name: "Ano Novo" },
                "21/04": { name: "Tiradentes" },
                "01/05": { name: "Dia do Trabalho" },
                "07/09": { name: "Independ√™ncia" },
                "12/10": { name: "Nossa Sra. Aparecida" },
                "02/11": { name: "Finados" },
                "15/11": { name: "Proclama√ß√£o da Rep√∫blica" },
                "20/11": { name: "Consci√™ncia Negra" },
                "25/12": { name: "Natal" }
            };
            h[formatDateKey(addDays(easter, -48).getDate(), addDays(easter, -48).getMonth())] = { name: "Carnaval" };
            h[formatDateKey(addDays(easter, -2).getDate(), addDays(easter, -2).getMonth())] = { name: "Sexta-feira Santa" };
            h[formatDateKey(addDays(easter, 60).getDate(), addDays(easter, 60).getMonth())] = { name: "Corpus Christi" };
            return h;
        }

        function getAstroEvents(year) {
            const events = {
                2025: { "14/03": "Lua de Sangue", "29/03": "Eclipse Solar", "07/09": "Lua de Sangue", "21/09": "Eclipse Solar" },
                2026: { "17/02": "Eclipse Solar", "03/03": "Lua de Sangue", "12/08": "Eclipse Solar" }
            };
            return events[year] || {};
        }

        function getMoonPhase(year, month, day) {
            const KNOWN_NEW_MOON = Date.UTC(2000, 0, 6, 18, 14, 0);
            const LUNAR_MONTH = 2551442877;
            const dateMs = new Date(year, month, day, 12).getTime();
            const phase = ((dateMs - KNOWN_NEW_MOON) % LUNAR_MONTH + LUNAR_MONTH) % LUNAR_MONTH / LUNAR_MONTH;
            if (phase < 0.03 || phase > 0.97) return { icon: "üåë", name: "Nova" };
            if (Math.abs(phase - 0.25) < 0.03) return { icon: "üåì", name: "Crescente" };
            if (Math.abs(phase - 0.50) < 0.03) return { icon: "üåï", name: "Cheia" };
            if (Math.abs(phase - 0.75) < 0.03) return { icon: "üåó", name: "Minguante" };
            return null;
        }

        function getSeasonClass(month, day) {
            const d = month * 100 + day;
            // Ver√£o: 21 Dez a 19 Mar (Amarelo)
            if (d >= 1121 || d < 220) return "bg-yellow-200";
            // Outono: 20 Mar a 20 Jun (Laranja)
            if (d >= 220 && d < 521) return "bg-orange-200";
            // Inverno: 21 Jun a 21 Set (Azul)
            if (d >= 521 && d < 822) return "bg-blue-200";
            // Primavera: 22 Set a 20 Dez (Rosa)
            if (d >= 822 && d < 1121) return "bg-pink-200";
            return "bg-white";
        }

        // --- GEST√ÉO DE DADOS ---
        function updateBdayList() {
            if (birthdays.length === 0) {
                bdayListContainer.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-4 uppercase font-bold">Sem registros</p>';
                return;
            }
            const sorted = [...birthdays].sort((a,b) => (a.month*100 + a.day) - (b.month*100 + b.day));

            bdayListContainer.innerHTML = sorted.map((b) => `
                <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-amber-100 shadow-sm hover:border-amber-400 transition group">
                    <div>
                        <div class="font-black text-amber-900 text-sm uppercase">${sanitize(b.name)}</div>
                        <div class="text-[10px] text-amber-600 font-bold">${b.day}/${b.month + 1}/${b.birthYear} - ${b.type || 'Anivers√°rio'}</div>
                    </div>
                    <button onclick="showConfirmModal('${sanitize(b.id)}')" class="text-gray-300 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeBday(id) {
            birthdays = birthdays.filter(b => b.id !== id);
            localStorage.setItem('user_birthdays_v3', JSON.stringify(birthdays));
            updateBdayList();
            renderCalendar(currentMonth, currentYear);
        }

        document.getElementById('add-bday').addEventListener('click', () => {
            const name = document.getElementById('bday-name').value;
            const dateVal = document.getElementById('bday-date').value;
            const type = document.getElementById('event-type').value;
            if (!name || !dateVal) return;

            const dateObj = new Date(dateVal + "T12:00:00");
            birthdays.push({
                id: Date.now().toString(),
                name,
                day: dateObj.getDate(),
                month: dateObj.getMonth(),
                birthYear: dateObj.getFullYear(),
                type
            });
            localStorage.setItem('user_birthdays_v3', JSON.stringify(birthdays));
            document.getElementById('bday-name').value = '';
            document.getElementById('bday-date').value = '';
            updateBdayList();
            renderCalendar(currentMonth, currentYear);
            showBackupModal();
        });

        // --- RENDER DO CALEND√ÅRIO ---
        function renderCalendar(month, year, targetGrid = calendarGrid, targetDisplay = monthYearDisplay) {
            if (targetDisplay) targetDisplay.textContent = `${monthNames[month]} ${year}`;
            targetGrid.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const holidays = getHolidays(year);
            const astro = getAstroEvents(year);

            const firstDaySeason = getSeasonClass(month, 1);

            if (!isListView) {
                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    empty.className = `${firstDaySeason} opacity-40 min-h-[140px] rounded-2xl border border-transparent`;
                    targetGrid.appendChild(empty);
                }
            }

            const dayOfWeekNames = ["DOMINGO", "SEGUNDA", "TER√áA", "QUARTA", "QUINTA", "SEXTA", "S√ÅBADO"];

            for (let d = 1; d <= daysInMonth; d++) {
                const key = formatDateKey(d, month);
                const holiday = holidays[key];
                const moon = getMoonPhase(year, month, d);
                const astroEvent = astro[key];
                const dayBdays = birthdays.filter(b => {
                    const isSameDayMonth = b.day === d && b.month === month;
                    if (b.type === "Evento √önico") {
                        return isSameDayMonth && b.birthYear === year;
                    }
                    return isSameDayMonth;
                });
                const seasonClass = getSeasonClass(month, d);
                const dayOfWeek = (firstDay + d - 1) % 7;

                const cell = document.createElement('div');
                const minH = isListView ? 'min-h-[80px]' : 'min-h-[140px]';
                let cellClasses = `relative ${seasonClass} ${minH} p-3 rounded-2xl border border-gray-100 flex flex-col hover:border-amber-200 transition-all`;
                let numClasses = "text-xl font-black numero-marrom";

                if (holiday) {
                    cellClasses = `relative ${seasonClass} brightness-95 ${minH} p-3 rounded-2xl border-2 border-amber-300 flex flex-col shadow-sm`;
                    numClasses = "text-xl font-black numero-marrom bg-amber-200 px-2 rounded-lg";
                }

                let html = `<div class="flex justify-between items-start">
                    <div class="flex items-center gap-2">
                        <span class="${numClasses}">${d}</span>
                        ${isListView ? `<span class="text-[10px] font-black text-amber-800/50">${dayOfWeekNames[dayOfWeek]}</span>` : ''}
                    </div>
                    ${moon ? `<span class="text-xl" title="${moon.name}">${moon.icon}</span>` : ''}
                </div>`;

                html += `<div class="flex-1 space-y-1.5 mt-2 overflow-hidden">`;

                if (holiday) html += `<div class="text-[10px] font-black text-amber-900 leading-tight uppercase bg-amber-200/50 p-1 rounded">${holiday.name}</div>`;
                if (astroEvent) html += `<div class="text-[10px] font-black text-purple-700 bg-purple-50 px-2 py-1 rounded-md border border-purple-100 uppercase">${astroEvent}</div>`;

                dayBdays.forEach(b => {
                    const age = year - b.birthYear;
                    const safeName = sanitize(b.name);
                    const isBday = (b.type === "Anivers√°rio" || !b.type);
                    const ageText = isBday ? ` (${age} anos)` : '';
                    const icon = isBday ? 'üéÅ' : 'üéØ';

                    html += `<div class="text-[10px] font-black text-blue-900 bg-blue-100 px-2 py-1 rounded-md border border-blue-200 truncate" title="${safeName}${isBday ? ` faz ${age} anos` : ''}">
                        ${icon} ${safeName}${ageText}
                    </div>`;
                });

                // Esta√ß√µes (Simplified)
                const seasonStyles = "text-[10px] font-black mt-auto pt-2 border-t uppercase tracking-tighter";
                if (key === "20/03") html += `<div class="${seasonStyles} text-orange-600 border-orange-100">üçÇ Equin. Outono</div>`;
                if (key === "21/06") html += `<div class="${seasonStyles} text-blue-600 border-blue-100">‚ùÑÔ∏è Solst. Inverno</div>`;
                if (key === "22/09") html += `<div class="${seasonStyles} text-pink-600 border-pink-100">üå∏ Equin. Primavera</div>`;
                if (key === "21/12") html += `<div class="${seasonStyles} text-amber-600 border-amber-100">‚òÄÔ∏è Solst. Ver√£o</div>`;

                html += `</div>`;
                cell.className = cellClasses;
                cell.innerHTML = html;
                targetGrid.appendChild(cell);
            }
        }

        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--; if(currentMonth < 0){ currentMonth=11; currentYear--; } renderCalendar(currentMonth, currentYear);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++; if(currentMonth > 11){ currentMonth=0; currentYear++; } renderCalendar(currentMonth, currentYear);
        });

        // --- EXPORTA√á√ÉO PDF ---
        document.getElementById('download-pdf').addEventListener('click', async () => {
            const btn = document.getElementById('download-pdf');
            const originalText = btn.innerText;
            btn.innerText = "GERANDO PDF...";
            btn.disabled = true;

            const startM = parseInt(pdfStartMonth.value);
            const startY = parseInt(pdfStartYear.value);
            const endM = parseInt(pdfEndMonth.value);
            const endY = parseInt(pdfEndYear.value);

            const startDate = new Date(startY, startM, 1);
            const endDate = new Date(endY, endM, 1);

            if (endDate < startDate) {
                alert("A data de fim deve ser posterior √† data de in√≠cio.");
                btn.innerText = originalText;
                btn.disabled = false;
                return;
            }

            const monthsToRender = [];
            let curr = new Date(startDate);
            while (curr <= endDate) {
                monthsToRender.push({ month: curr.getMonth(), year: curr.getFullYear() });
                curr.setMonth(curr.getMonth() + 1);
            }

            const tempContainer = document.getElementById('pdf-render-temp');
            tempContainer.innerHTML = '';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 10;

                for (let i = 0; i < monthsToRender.length; i++) {
                    const item = monthsToRender[i];
                    if (i > 0) doc.addPage();

                    const monthWrapper = document.createElement('div');
                    monthWrapper.className = "p-4 bg-white border border-gray-100";
                    monthWrapper.style.width = "1100px";

                    const header = document.createElement('div');
                    header.className = "flex justify-center mb-4";
                    const title = document.createElement('h2');
                    title.className = "text-4xl font-black text-amber-900 uppercase";
                    header.appendChild(title);
                    monthWrapper.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-7 gap-2";
                    monthWrapper.appendChild(grid);
                    tempContainer.appendChild(monthWrapper);

                    renderCalendar(item.month, item.year, grid, title);

                    const days = ["DOM", "SEG", "TER", "QUA", "QUI", "SEX", "S√ÅB"];
                    [...days].reverse().forEach(d => {
                        const dayHead = document.createElement('div');
                        dayHead.className = "text-center font-black text-amber-800 py-2 text-sm border-b-2 border-amber-100";
                        dayHead.innerText = d;
                        grid.prepend(dayHead);
                    });

                    const canvas = await html2canvas(monthWrapper, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: "#ffffff",
                        logging: false
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const imgProps = doc.getImageProperties(imgData);
                    const imgWidth = pageWidth - (2 * margin);
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                    doc.addImage(imgData, 'JPEG', margin, margin, imgWidth, imgHeight);
                    tempContainer.innerHTML = '';
                }

                doc.save(`Calendario_Exportacao_${startY}_${endY}.pdf`);
            } catch (err) {
                console.error("Erro ao gerar PDF:", err);
                alert("Erro ao gerar PDF. Verifique o console.");
            } finally {
                tempContainer.innerHTML = '';
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // --- BACKUP DE DADOS ---
        document.getElementById('export-data').addEventListener('click', () => {
            if (birthdays.length === 0) {
                alert("Nenhum dado para exportar.");
                return;
            }
            const sorted = [...birthdays].sort((a, b) => (a.month * 100 + a.day) - (b.month * 100 + b.day));
            let content = "";
            sorted.forEach(b => {
                const day = b.day.toString().padStart(2, '0');
                const month = (b.month + 1).toString().padStart(2, '0');
                const year = b.birthYear;
                content += `${day}/${month}/${year} - ${b.name}\n`;
            });

            const blob = new Blob([content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Backup_Eventos_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-data-trigger').addEventListener('click', () => {
            document.getElementById('import-data-file').click();
        });

        document.getElementById('import-data-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const content = event.target.result;
                let importedData = [];

                try {
                    // Tenta JSON primeiro (legado)
                    const parsed = JSON.parse(content);
                    if (Array.isArray(parsed)) {
                        importedData = parsed;
                    }
                } catch (e) {
                    // Se falhar JSON, tenta processar como TXT
                    const lines = content.split('\n');
                    lines.forEach(line => {
                        const match = line.match(/^(\d{2})\/(\d{2})\/(\d{4}) - (.+)$/);
                        if (match) {
                            const [_, day, month, year, name] = match;
                            importedData.push({
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                name: name.trim(),
                                day: parseInt(day),
                                month: parseInt(month) - 1,
                                birthYear: parseInt(year)
                            });
                        }
                    });
                }

                if (importedData.length > 0) {
                    birthdays = importedData;
                    localStorage.setItem('user_birthdays_v3', JSON.stringify(birthdays));
                    updateBdayList();
                    renderCalendar(currentMonth, currentYear);
                    alert('Dados importados com sucesso!');
                } else {
                    alert('Nenhum dado v√°lido encontrado para importar.');
                }
                e.target.value = ''; // Reset input
            };
            reader.readAsText(file);
        });

        function updateLayout() {
            const container = document.getElementById('calendar-container-inner');
            const header = document.getElementById('calendar-days-header');
            const grid = document.getElementById('calendar-grid');
            const icon = document.getElementById('layout-icon');

            if (isListView) {
                container.classList.remove('min-w-[900px]');
                header.classList.add('hidden');
                grid.classList.remove('grid-cols-7', 'gap-3');
                grid.classList.add('grid-cols-1', 'gap-4');
                // Icon: 4 squares (Grid)
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />';
            } else {
                container.classList.add('min-w-[900px]');
                header.classList.remove('hidden');
                grid.classList.remove('grid-cols-1', 'gap-4');
                grid.classList.add('grid-cols-7', 'gap-3');
                // Icon: 3 lines (List)
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />';
            }
            renderCalendar(currentMonth, currentYear);
        }

        document.getElementById('toggle-layout').addEventListener('click', () => {
            isListView = !isListView;
            updateLayout();
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth === lastWidth) return;
            lastWidth = window.innerWidth;

            const shouldBeList = window.innerWidth < 768;
            if (shouldBeList !== isListView) {
                isListView = shouldBeList;
                updateLayout();
            }
        });

        updateBdayList();
        updateLayout();
    </script>
</body>
</html>